<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Automated E2e API Testing/Documentation for Node.js &#8211; Hardcore trial & error</title>
<meta name="description" content="My journey through code and development">
<meta name="keywords" content="">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/mocha.jpg">

<meta name="twitter:title" content="Automated E2e API Testing/Documentation for Node.js">
<meta name="twitter:description" content="My journey through code and development">
<meta name="twitter:creator" content="@jestersimpps">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Automated E2e API Testing/Documentation for Node.js">
<meta property="og:description" content="My journey through code and development">
<meta property="og:url" content="/automated-e2e-api-testing-documentation-for-node-js/">
<meta property="og:site_name" content="Hardcore trial & error">





<link rel="canonical" href="/automated-e2e-api-testing-documentation-for-node-js/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Hardcore trial & error Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="/images/bio-photo.png" alt="Jester Simpps photo" class="author-photo">
					<h4>Jester Simpps</h4>
					<p></p>
				</li>
				<li><a href="/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:jestersimpps@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="http://twitter.com/jestersimpps"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				
				
				<li>
					<a href="http://linkedin.com/in/jo-vinkenroye/63/a79/459"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
				</li>
				<li>
					<a href="http://github.com/jestersimpps"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				<li>
					<a href="http://instagram.com/jestersimpps"><i class="fa fa-fw fa-instagram"></i> Instagram</a>
				</li>
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="/posts/">All Posts</a></li>
				<li><a href="/tags/">All Tags</a></li>
			</ul>
		</li>
		
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    <img src="/images/mocha.jpg" alt="Automated E2e API Testing/Documentation for Node.js">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/automated-e2e-api-testing-documentation-for-node-js/" rel="bookmark" title="Automated E2e API Testing/Documentation for Node.js">Automated E2e API Testing/Documentation for Node.js</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2016-07-22T06:46:58-04:00">July 22, 2016</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~10 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>This was my first time doing test driven API development in Node.js and I must say, I really enjoyed it. I used to fall back on a Chrome plugin called <a href="https://www.getpostman.com/">Postman</a> a lot before getting used to Mocha and test driven development. It was a joy to write code for a test that described what the endpoint should do before actually coding the new endpoint. It made me think more about the code I was going to write and what it should do. It also happened sometimes that there would be a total API overhaul (like the implementation of softdeletes). And, man was I glad I had written unit tests for all my endpoints when that happened!</p>

<h2 id="butwait-wont-i-lose-a-lot-of-time-doing-that">But…wait.. won’t I lose a lot of time doing that?!?</h2>

<p><img src="https://risingstack-blog.s3-eu-west-1.amazonaws.com/2014/Oct/unit_testing.jpeg" alt="unit tests" /></p>

<p>Writing API tests for a node.js API can be a tedious job. We are dealing with a single event loop, so we need to take in account callbacks. Especially when doing API testing, callbacks can quickly become a pain point. A lot of times, checking whether requests work means triggering other requests sequentially to see if the database was updated by previous requests. This is why, after refactoring a bit of my tests, I was able to create a simple end-to-end testscript that I would just call whenever I wrote a new route. Every time with different input data specific to the route of course. I was later able to tie in APIDoc, a documentation generator that will create a frontend containing the documentation for all your endpoints. So in the end all my endpoints were not only fully tested, but also automatically documented in one go. This was very nice and saved me a lot of time.</p>

<h2 id="dependencies">Dependencies</h2>

<h3 id="testing">Testing</h3>

<ul>
  <li>We will be using <a href="https://mochajs.org/">Mocha</a> as a testing framework for our Node.js API.</li>
  <li>Mocha is great, but not perfect, so on top of it, we will include the <a href="https://github.com/visionmedia/supertest">supertest</a> package that will provide abstraction for HTTP testing.</li>
  <li>As I refactored my end to end tests into one single testscript, we will also need a package called <a href="https://www.npmjs.com/package/partial-compare">partial compare</a> that will do partial matching between test objects and actual return-objects from the api.</li>
  <li>We will also use <a href="https://www.npmjs.com/package/should">should</a> to make our testing code more human readable and easier to write.</li>
</ul>

<h3 id="api-documentation">API documentation</h3>

<ul>
  <li>A great library called <a href="http://apidocjs.com/">APIdoc</a> will take care of documenting all of the endpoints</li>
  <li>A plugin of that library <a href="https://www.npmjs.com/package/apidoc-plugin-schema">apidoc-plugin-schema</a> will make our life easier.</li>
</ul>

<p>In the package.json file:</p>

<pre><code>"devDependencies": {
  "apidoc-plugin-schema": "0.0.4",
  "body-parser": "~1.8.1",
  "fs": "0.0.2",
  "jsonfile": "^2.3.1",
  "mocha": "^2.1.0",
  "partial-compare": "^1.0.1",
  "path": "^0.12.7",
  "should": "~4.6.2",
  "supertest": "^0.15.0",
  "type-of-is": "^3.4.0"
}
</code></pre>

<h2 id="end-to-end-testing">End to end testing</h2>

<p>Wikipedia says:</p>

<blockquote>
  <p>End-to-end testing is a technique used to test whether the flow of an application right from start to finish is behaving as expected. The purpose of performing end-to-end testing is to identify system dependencies and to ensure that the data integrity is maintained between various system components and systems.</p>
</blockquote>

<p>Translate this to API testing and you get:</p>

<ol>
  <li>GET an array of existing data</li>
  <li>POST some new data</li>
  <li>Test if the new data was posted</li>
  <li>Change the new data using PUT</li>
  <li>Test if the new data was changed</li>
  <li>DELETE the new data</li>
  <li>Test if the new data was removed</li>
</ol>

<p>Of course this is the most simple scenario of RESTful API testing, and I know there’s some other endpoints that can be more complex (like counters, searches, etc.) But I will not elaborate on these in this post as these most of the time imply writing custom tests.</p>

<h2 id="a-test-script-that-covers-multiple-endpoints">A test script that covers multiple endpoints</h2>

<p>Because the sequence of testing is the same for all endpoints, I created a general script that will test different endpoints using the same code but different input based on the endpoint’s data. The input data will be stored in an object that will be called from an endpoint file in the ‘test/routes’ folder.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">├── <span class="nb">test</span>
<span class="p">|</span>    ├── routes  
<span class="p">|</span>         ├── endpoint1.js
<span class="p">|</span>         ├── endpoint2.js
<span class="p">|</span>         ├── endpoint3.js
<span class="p">|</span>    ├── e2e_tests.js
<span class="p">|</span>    ├── schema_generator.js
<span class="p">|</span>              </code></pre></figure>

<p>The content of the endpoint file will contain the e2e_test options object which has some options for the endpoint tests and apidoc generator.
Next to the options, a testData object contains all data needed to perform the tests. The object attributes are pretty self explanatory:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">//define the e2e script</span>
<span class="kr">const</span> <span class="nx">e2e</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./e2e_tests.js&#39;</span><span class="p">);</span>
<span class="c1">// this should refer to the express app you have set up for your api</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>

<span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>

	<span class="kd">let</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">//timeout between requests</span>
		<span class="nx">timeout</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="c1">//your express app</span>
		<span class="nx">api</span><span class="o">:</span> <span class="nx">app</span><span class="p">,</span>
    <span class="c1">//generate apidoc or not?</span>
		<span class="nx">apidoc</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="c1">//where do you want to store the schema jsons for the apidoc schema plugin?</span>
		<span class="nx">schemaDir</span><span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="err">`</span><span class="o">/</span><span class="p">..</span><span class="o">/</span><span class="nx">data</span><span class="o">/</span><span class="nx">apischemas</span><span class="o">/</span><span class="err">`</span>
	<span class="p">}</span>


	<span class="kd">let</span> <span class="nx">testData</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nx">routeName</span><span class="o">:</span> <span class="s1">&#39;Articles&#39;</span><span class="p">,</span>
		<span class="nx">postObject</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;this is an article&#39;</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="nx">expectedObjectAfterPost</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;this is an article&#39;</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="nx">putObject</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;this is an article too&#39;</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="nx">expectedObjectAfterPut</span><span class="o">:</span> <span class="p">{</span>
			<span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;this is an article too&#39;</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">};</span>

  <span class="c1">//You can then call a unit test for this endpoint by calling the script:</span>
	<span class="nx">e2e</span><span class="p">(</span><span class="nx">testData</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>


<span class="p">})();</span></code></pre></figure>

<p>When we run mocha the end-to-end script will be called and run all tests for that endpoint. If you have specified a schemaDir and the apidoc boolean is set to true, the script will also automatically generate json schemas for the apidoc based on the testData.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">node_modules/.bin/mocha</code></pre></figure>

<p>Console output for a working API should be similar to:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">-------- Albums tests --------

GET /Albums <span class="m">200</span> 148.080 ms - 2
Counting Albums: 0
    ✓ Should <span class="k">return</span> an array of Albums
--POST shows/: <span class="o">{</span><span class="s2">&quot;general&quot;</span>:<span class="o">{</span><span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;Ascot&quot;</span><span class="o">}</span>,<span class="s2">&quot;time&quot;</span>:<span class="o">{</span><span class="s2">&quot;startDate&quot;</span>:<span class="s2">&quot;2016-04-06T21:51:15.000Z&quot;</span><span class="o">}</span>,<span class="s2">&quot;type&quot;</span>:<span class="s2">&quot;album&quot;</span><span class="o">}</span>
POST /Albums <span class="m">200</span> 151.935 ms - 1996
Adding: <span class="m">1</span> Album
    ✓ Should create a new Album
GET /Albums/5789159e34150fe84c463f28 <span class="m">200</span> 117.938 ms - 1996
    ✓ Should get the new Album
GET /Albums <span class="m">200</span> 103.512 ms - 1998
Counting Albums: 1, should be: 1
    ✓ Should <span class="k">return</span> an array of Albums with the correct size
PUT /Albums/5789159e34150fe84c463f28 <span class="m">200</span> 115.422 ms - 1997
    ✓ Should change a Album
GET /Albums/5789159e34150fe84c463f28 <span class="m">200</span> 102.205 ms - 1997
    ✓ Should get the changed Album
DELETE /Albums/5789159e34150fe84c463f28 <span class="m">200</span> 116.241 ms - 2018
Removing: <span class="m">1</span> Album
    ✓ Should remove a Album
GET /Albums <span class="m">200</span> 104.573 ms - 2
Counting Albums: 0, should be: 0
    ✓ Should get an array without the deleted Album

-------- Articles tests --------

GET /Articles <span class="m">200</span> 92.230 ms - 2
Counting Articles: 0
    ✓ Should <span class="k">return</span> an array of Articles
POST /Articles <span class="m">200</span> 98.047 ms - 300
Adding: <span class="m">1</span> Article
    ✓ Should create a new Article
GET /Articles/578915a134150fe84c463f39 <span class="m">200</span> 99.768 ms - 300
    ✓ Should get the new Article
GET /Articles <span class="m">200</span> 107.985 ms - 302
Counting Articles: 1, should be: 1
    ✓ Should <span class="k">return</span> an array of Articles with the correct size
DELETE /Articles/578915a134150fe84c463f39 <span class="m">200</span> 99.193 ms - 329
Removing: <span class="m">1</span> Article
    ✓ Should remove a Article
GET /Articles <span class="m">200</span> 101.275 ms - 304
Counting Articles: 0, should be: 0
    ✓ Should get an array without the deleted Article


  <span class="m">2</span> passing <span class="o">(</span>4s<span class="o">)</span>

info: Done.</code></pre></figure>

<h2 id="api-documentation-generator">API documentation generator</h2>

<p>In your route files, above your endpoints, you can then add the following comment blocks:</p>

<ul>
  <li><a href="https://github.com/jestersimpps/node_rest_test_doc/blob/master/test/routes/APIDOC.md">api doc helpers</a></li>
</ul>

<p>Change them according to your endpoints of course. They will be used by the APIdoc generator to create the documentation frontend.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="cm">/**</span>
<span class="cm">* @apiSchema {jsonschema=../test/data/apischemas/&lt;routecaps&gt;-POST-create-a-new-&lt;routesingle&gt;-PARAMS.json} apiParam</span>
<span class="cm">* @apiSchema {jsonschema=../test/data/apischemas/&lt;routecaps&gt;-POST-create-a-new-&lt;routesingle&gt;-SUCCESS.json} apiSuccess</span>
<span class="cm">*/</span></code></pre></figure>

<p>The apiSchema references in the comments displayed above will point at the schema jsons that are generated by the <a href="https://github.com/jestersimpps/node_rest_test_doc/blob/master/test/schema_generator.js">schema_generator</a>.
The output directory can be changed in the options object in the endpoint test file as illustrated earlier.</p>

<p>Assuming the <code>./routes</code> folder contains your api’s route files and the <code>./public</code> folder is the folder that will contain the apidoc frontend, generate your api documentation by running:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">apidoc -i ./routes -o ./public/</code></pre></figure>

<p>These tests were run using mongoDB, which uses <code>_id</code> as a primary key. You might have to edit the test script to your needs a bit when you are using a different database or key/slug to perform individual GET,PUT,DELETE requests.</p>

<p>The entire code and scripts can be found <a href="https://github.com/jestersimpps/node_rest_test_doc">here</a></p>

      <footer class="entry-meta">
        <span class="entry-tags"></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/automated-e2e-api-testing-documentation-for-node-js/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/automated-e2e-api-testing-documentation-for-node-js/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=/automated-e2e-api-testing-documentation-for-node-js/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="/smart-contract-blockchain-platforms/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="/smart-contract-blockchain-platforms/" title="An overview of the Blockchain development Ecosystem">An overview of the Blockchain development Ecosystem</a></h3>
      <p>This is an effort in mapping out the current ecosystem of tools and platforms that facilitate development of ‘smart contracts’ or ‘Autono...&hellip; <a href="/smart-contract-blockchain-platforms/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="/my-first-experience-with-bitpay-bitcore/" title="Sending Bitcoins using Bitcore and node.js">Sending Bitcoins using Bitcore and node.js</a></h4>
        <span>Published on May 20, 2016</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="/getting-around-the-product-variant-limitation-in-shopify/" title="Getting Around the Product Variant Limitation in Shopify">Getting Around the Product Variant Limitation in Shopify</a></h4>
        <span>Published on May 13, 2016</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2016 Jester Simpps. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67531656-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>



    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jestersimpps'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	        

</body>
</html>
